<?php

namespace App\Http\Controllers;

use App\Models\Company;
use App\Models\CompanyVerification;
use App\Models\JobListing;
use App\Models\ReportedJob;
use App\Models\Tag;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Validation\Rule;

class AdminController extends Controller
{
    // Submission Page 
    public function companyDocumentSubmission() {
        $companies_document = Company::with("verification")->whereHas("verification", fn ($q) => $q->where("status", "waiting"))->get();
        return view("admin.company-verification-submission", compact('companies_document'));
    }

    // Submission Page Post
    public function companyDocumentSubmissionPOST(Request $request) {
        $validated = $request->validate([
            "id" => "required",
            "type" => ["required", Rule::in("review")]
        ]);

        $res = CompanyVerification::where("company_id", $validated['id'])->update([
            "status" => "under-review"
        ]);

        if($res){
            return redirect()->back();
        }
    }

    public function category() {    
        $tags = Tag::paginate(3);
        return view("admin.category", compact("tags"));
    }

    public function companyDocumentInReview() {
        $companies_document = Company::with("verification")->whereHas("verification", fn ($q) => $q->where("status", "in-review"))->get();
        return view("admin.company-verification-in-review", compact('companies_document'));
    }

    public function companyDocumentInReviewPOST(Request $request){

        $validated = $request->validate([
            "id" => "required",
            "type" => ["required", Rule::in(["rejected", "approved"])]
        ]);

        // $res = Company::where("id", $validated['id'])->first();

        $res = CompanyVerification::where("company_id", $validated["id"])->update([
            "status" => $validated["type"]
        ]);

        if($res){
            return redirect("/");
        }
        dd($validated, $res);
    }

    public function companyDetail(string $id) {
        if(isset($id)){
            $company = Company::with(["verification", "link"])->where("id", $id)->first();
            return view("admin.components.company-detail", compact('company'));
        }
    }

    // tag/category created by related company
    public function deleteCategoryPOST(Request $request) {

        $validated = $request->validate([
            "id" => "required",
        ]);

        $res = Tag::where("id", $validated["id"])->delete();

        if($res >= 1){
            return redirect()->to("/admin/category");
        }
    }

    public function reportedJobs() {
        $jobs = JobListing::withCount("reported")->get();
        $total_reported = ReportedJob::count();
        return view("admin.reported-job", compact("jobs"), compact("total_reported"));
    }

    public function listReportMessage(string $id) {
        $job = JobListing::where("id", $id)->first();
        $reported_jobs = ReportedJob::where("job_listing_id", $id)->get();
        return view("admin.list-report", compact("reported_jobs"), compact("job"));
    }

    public function reportedJobDetail(string $id) {
        return view("admin.components.reported-job-detail");
    }
}


